<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Plan Report</title>
    <style>
        :root {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f3f5fb;
            color: #081f3f;
        }
        body {
            margin: 0;
            background: #f3f5fb;
        }
        header {
            padding: 24px;
            background: linear-gradient(135deg, #1433a6, #2c91ff);
            color: white;
        }
        header h1 {
            margin: 0 0 8px;
            font-size: 22px;
        }
        header p {
            margin: 0;
            opacity: 0.9;
        }
        main {
            padding: 24px;
            display: grid;
            gap: 24px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }
        .summary-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 12px 28px rgba(8, 31, 63, 0.08);
        }
        .summary-card strong {
            font-size: 24px;
            display: block;
        }
        .summary-card span {
            color: #5f6f8c;
        }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .chart-box {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 12px 28px rgba(8, 31, 63, 0.08);
            overflow-x: auto;
        }
        .chart-box h3 {
            margin: 0 0 8px;
            font-size: 16px;
        }
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }
        .filters label {
            font-size: 13px;
            color: #47516b;
        }
        .filters select,
        .filters input {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #d7ddf8;
            background: white;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(8, 31, 63, 0.08);
            overflow: hidden;
        }
        th, td {
            padding: 12px 14px;
            border-bottom: 1px solid #edf1ff;
            text-align: left;
            font-size: 14px;
        }
        th {
            background: #f7f9ff;
            color: #4a5670;
            font-weight: 600;
        }
        .badge {
            border-radius: 999px;
            padding: 4px 10px;
            color: white;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .badge.NEW { background: #2d9cdb; }
        .badge.UPDATE { background: #f0ad4e; }
        .badge.DELETE { background: #d6364a; }
        .details-panel {
            background: #f7f9ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 6px;
        }
        .details-panel pre {
            max-height: 220px;
            overflow: auto;
            background: white;
            border-radius: 6px;
            padding: 10px;
            border: 1px solid #dfe5ff;
            margin: 6px 0 0;
            font-size: 13px;
        }
        button {
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            background: #1f3cb6;
            color: white;
            font-size: 13px;
            cursor: pointer;
        }
        button.secondary {
            background: #e7eafc;
            color: #1f3cb6;
        }
        .modal-mask {
            position: fixed;
            inset: 0;
            display: none;
            background: rgba(8, 31, 63, 0.55);
            align-items: center;
            justify-content: center;
            z-index: 9;
        }
        .modal {
            background: white;
            border-radius: 16px;
            padding: 22px;
            max-width: 880px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(8, 31, 63, 0.25);
        }
        .modal h2 {
            margin: 0 0 8px;
            font-size: 18px;
        }
        .diff-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 18px;
            margin-top: 12px;
        }
        .diff-columns pre {
            max-height: 320px;
            overflow: auto;
            background: #f7f9ff;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid #dfe5ff;
            font-size: 13px;
        }
        .close-btn {
            background: transparent;
            color: #1f3cb6;
            font-size: 16px;
            float: right;
            padding: 0;
        }
    </style>
</head>
<body>
<header>
    <h1>Master Plan Report</h1>
    <p>Browse KPIs, charts, filters, and inline diffs without touching the JSON.</p>
</header>
<main>
    <section class="summary-grid" id="summaryGrid"></section>
    <section class="charts">
        <div class="chart-box">
            <h3>Action distribution</h3>
            <canvas id="actionDonut" width="320" height="240"></canvas>
        </div>
        <div class="chart-box">
            <h3>Category Ã— action</h3>
            <canvas id="categoryStack" width="320" height="240"></canvas>
        </div>
    </section>
    <section>
        <div class="filters">
            <label for="categoryFilter">Category</label>
            <select id="categoryFilter">
                <option value="">All</option>
            </select>
            <label for="actionFilter">Action</label>
            <select id="actionFilter">
                <option value="">All</option>
                <option value="NEW">New</option>
                <option value="UPDATE">Update</option>
                <option value="DELETE">Delete</option>
            </select>
            <label for="searchInput">Search</label>
            <input id="searchInput" type="search" placeholder="Key search" />
            <button id="sortByAction" class="secondary">Sort by action</button>
        </div>
        <table>
            <thead>
            <tr>
                <th>Action</th>
                <th>Category</th>
                <th>Key</th>
                <th>Source path</th>
                <th>Details</th>
            </tr>
            </thead>
            <tbody id="reviewBody"></tbody>
        </table>
    </section>
</main>
<div class="modal-mask" id="diffModal">
    <div class="modal">
        <button class="close-btn" id="closeModal">Close</button>
        <h2>Field-level diff</h2>
        <p id="diffKeys"></p>
        <div class="diff-columns">
            <div>
                <strong>Before</strong>
                <pre id="beforeJson"></pre>
            </div>
            <div>
                <strong>After</strong>
                <pre id="afterJson"></pre>
            </div>
        </div>
    </div>
</div>
<script>
    const planData = {
  "items" : [ {
    "action" : "UPDATE",
    "fileCategory" : "POLICIES",
    "key" : "allow-access-full-policy",
    "sourcePath" : "configs\\policies\\allow-access-full-policy.json",
    "payload" : {
      "code" : "allow-access-full-policy",
      "description" : "New Example policy demonstrating their creation update 2333",
      "applications" : [ "LUSID" ],
      "grant" : "ALLOW",
      "selectors" : [ {
        "idSelectorDefinition" : {
          "identifier" : {
            "scope" : "official"
          },
          "actions" : [ {
            "scope" : "default",
            "activity" : "Read",
            "entity" : "Portfolio"
          }, {
            "scope" : "default",
            "activity" : "Aggregate",
            "entity" : "Portfolio"
          } ],
          "name" : "access-official-scope",
          "description" : "Allow readonly access to the 'official' scope"
        }
      } ],
      "when" : {
        "activate" : "2018-03-05T18:00:00.001Z",
        "deactivate" : "2018-03-05T18:00:00.001Z"
      },
      "for" : [ {
        "effectiveRange" : {
          "from" : "2018-03-05T18:00:00.001Z",
          "to" : "2018-03-05T18:00:00.001Z"
        }
      }, {
        "asAtRangeForSpec" : {
          "from" : {
            "dateTimeOffset" : "2018-03-05T18:00:00.001Z"
          },
          "to" : {
            "value" : "AsAt=Latest"
          }
        }
      } ]
    },
    "beforePayload" : {
      "code" : "allow-access-full-policy",
      "description" : "New Example policy demonstrating their creation update 23",
      "applications" : [ "LUSID" ],
      "grant" : "ALLOW",
      "selectors" : [ {
        "idSelectorDefinition" : {
          "identifier" : {
            "scope" : "official"
          },
          "actions" : [ {
            "scope" : "default",
            "activity" : "Read",
            "entity" : "Portfolio"
          }, {
            "scope" : "default",
            "activity" : "Aggregate",
            "entity" : "Portfolio"
          } ],
          "name" : "access-official-scope",
          "description" : "Allow readonly access to the 'official' scope"
        }
      } ],
      "when" : {
        "activate" : "2018-03-05T18:00:00.001Z",
        "deactivate" : "2018-03-05T18:00:00.001Z"
      },
      "for" : [ {
        "effectiveRange" : {
          "from" : "2018-03-05T18:00:00.001Z",
          "to" : "2018-03-05T18:00:00.001Z"
        }
      }, {
        "asAtRangeForSpec" : {
          "from" : {
            "dateTimeOffset" : "2018-03-05T18:00:00.001Z"
          },
          "to" : {
            "value" : "AsAt=Latest"
          }
        }
      } ]
    }
  } ]
};
    const items = planData.items || [];
    const actionColors = {NEW: '#2d9cdb', UPDATE: '#f0ad4e', DELETE: '#d6364a'};

    const summaryGrid = document.getElementById('summaryGrid');
    const reviewBody = document.getElementById('reviewBody');
    const categoryFilter = document.getElementById('categoryFilter');
    const actionFilter = document.getElementById('actionFilter');
    const searchInput = document.getElementById('searchInput');
    const sortButton = document.getElementById('sortByAction');
    const diffModal = document.getElementById('diffModal');
    const closeModal = document.getElementById('closeModal');
    const beforeJson = document.getElementById('beforeJson');
    const afterJson = document.getElementById('afterJson');
    const diffKeys = document.getElementById('diffKeys');

    const actionBuckets = {NEW: 0, UPDATE: 0, DELETE: 0};

    items.forEach(item => {
        const action = item.action || 'UNKNOWN';
        if (actionBuckets[action] !== undefined) {
            actionBuckets[action]++;
        }
        const category = item.fileCategory || 'Unknown';
        if (!Array.from(categoryFilter.options).some(opt => opt.value === category)) {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categoryFilter.appendChild(option);
        }
    });

    function renderSummary() {
        summaryGrid.innerHTML = '';
        const total = items.length;
        const tiles = [
            ['Total', total],
            ['New', actionBuckets.NEW],
            ['Update', actionBuckets.UPDATE],
            ['Delete', actionBuckets.DELETE]
        ];
        tiles.forEach(([label, value]) => {
            const card = document.createElement('div');
            card.className = 'summary-card';
            card.innerHTML = `<strong>${value}</strong><span>${label}</span>`;
            summaryGrid.appendChild(card);
        });
    }

    function drawDonut() {
        const canvas = document.getElementById('actionDonut');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const radius = Math.min(canvas.width, canvas.height) / 2 - 16;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const total = Object.values(actionBuckets).reduce((sum, c) => sum + c, 0) || 1;
        let start = -Math.PI / 2;
        Object.entries(actionBuckets).forEach(([action, count]) => {
            if (count === 0) return;
            const slice = (count / total) * Math.PI * 2;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, start, start + slice);
            ctx.closePath();
            ctx.fillStyle = actionColors[action] || '#a5b3e6';
            ctx.fill();
            start += slice;
        });
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius * 0.55, 0, Math.PI * 2);
        ctx.fillStyle = '#f3f5fb';
        ctx.fill();
        ctx.fillStyle = '#081f3f';
        ctx.font = 'bold 18px "Segoe UI"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(items.length, centerX, centerY);
    }

    function drawStackedBar() {
        const canvas = document.getElementById('categoryStack');
        const ctx = canvas.getContext('2d');
        const stats = {};
        items.forEach(item => {
            const category = item.fileCategory || 'Unknown';
            stats[category] = stats[category] || {NEW: 0, UPDATE: 0, DELETE: 0};
            const action = item.action || 'UNKNOWN';
            if (stats[category][action] !== undefined) {
                stats[category][action]++;
            }
        });
        const categories = Object.keys(stats);
        const requiredWidth = Math.max(480, categories.length * 90);
        canvas.width = requiredWidth;
        canvas.style.width = `${Math.min(requiredWidth, 900)}px`;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const max = Math.max(1, ...categories.map(cat => Object.values(stats[cat]).reduce((a, b) => a + b, 0)));
        const barWidth = Math.max(24, canvas.width / (categories.length * 2));
        categories.forEach((category, index) => {
            let heightBase = canvas.height - 30;
            const currentX = 20 + index * (barWidth * 1.8);
            const catStats = stats[category];
            Object.entries(catStats).forEach(([action, value]) => {
                const barHeight = (value / max) * (canvas.height - 60);
                ctx.fillStyle = actionColors[action] || '#a5b3e6';
                ctx.fillRect(currentX, heightBase - barHeight, barWidth, barHeight);
                heightBase -= barHeight;
            });
            ctx.fillStyle = '#081f3f';
            ctx.font = '12px "Segoe UI"';
            ctx.textAlign = 'center';
            ctx.fillText(category, currentX + barWidth / 2, canvas.height - 8);
        });
    }

    function buildRow(item, index) {
        const row = document.createElement('tr');
        const action = item.action || 'UNKNOWN';
        row.innerHTML = `
            <td><span class="badge ${action}">${action}</span></td>
            <td>${item.fileCategory || 'Unknown'}</td>
            <td>${item.key || ''}</td>
            <td>${item.sourcePath || ''}</td>
            <td></td>
        `;
        const detailCell = row.querySelector('td:last-child');
        const details = document.createElement('details');
        const summary = document.createElement('summary');
        summary.textContent = 'Payload';
        const panel = document.createElement('div');
        panel.className = 'details-panel';
        const desc = document.createElement('p');
        desc.textContent = item.action === 'DELETE' ? 'Before payload' : 'Payload';
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(item.payload || {}, null, 2);
        panel.appendChild(desc);
        panel.appendChild(pre);
        if (item.action === 'UPDATE') {
            const diffBtn = document.createElement('button');
            diffBtn.textContent = 'View diff';
            diffBtn.addEventListener('click', () => showDiff(item.beforePayload, item.payload));
            panel.appendChild(diffBtn);
        }
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy';
        copyBtn.style.marginLeft = '8px';
        copyBtn.addEventListener('click', () => copyToClipboard(pre.textContent));
        panel.appendChild(copyBtn);
        details.appendChild(summary);
        details.appendChild(panel);
        detailCell.appendChild(details);
        return row;
    }

    function renderTable(list) {
        reviewBody.innerHTML = '';
        list.forEach((item, index) => {
            reviewBody.appendChild(buildRow(item, index));
        });
    }

    function copyToClipboard(value) {
        try {
            navigator.clipboard.writeText(value);
        } catch (e) {
            console.warn('Clipboard failed', e);
        }
    }

    function showDiff(before, after) {
        beforeJson.textContent = JSON.stringify(before || {}, null, 2);
        afterJson.textContent = JSON.stringify(after || {}, null, 2);
        const changed = computeChanges(before || {}, after || {});
        diffKeys.textContent = changed.length ? `Changed keys: ${changed.join(', ')}` : 'No key-level changes.';
        diffModal.style.display = 'flex';
    }

    closeModal.addEventListener('click', () => {
        diffModal.style.display = 'none';
    });

    function computeChanges(a, b, prefix = '') {
        const keys = new Set([...Object.keys(a), ...Object.keys(b)]);
        const changes = [];
        keys.forEach(key => {
            const currentPath = prefix ? `${prefix}.${key}` : key;
            const valA = a[key];
            const valB = b[key];
            if (typeof valA === 'object' && valA !== null && typeof valB === 'object' && valB !== null) {
                changes.push(...computeChanges(valA, valB, currentPath));
            } else if (JSON.stringify(valA) !== JSON.stringify(valB)) {
                changes.push(currentPath);
            }
        });
        return changes;
    }

    function applyFilters() {
        const action = actionFilter.value;
        const category = categoryFilter.value;
        const search = searchInput.value.trim().toLowerCase();
        const filtered = items.filter(item => {
            const matchesAction = action ? item.action === action : true;
            const matchesCategory = category ? item.fileCategory === category : true;
            const matchesSearch = !search || `${item.key || ''}`.toLowerCase().includes(search);
            return matchesAction && matchesCategory && matchesSearch;
        });
        renderTable(filtered);
    }

    function sortByAction() {
        const order = {NEW: 1, UPDATE: 2, DELETE: 3};
        items.sort((a, b) => (order[a.action] || 0) - (order[b.action] || 0));
        applyFilters();
    }

    categoryFilter.addEventListener('change', applyFilters);
    actionFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
    sortButton.addEventListener('click', sortByAction);

    renderSummary();
    drawDonut();
    drawStackedBar();
    applyFilters();
</script>
</body>
</html>
